name: Build & Deploy

on:
  push:
    branches:
      - master
      - staging

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set environment
        run: |
          if [[ "${GITHUB_REF_NAME}" == "master" ]]; then
            echo "ENV=prod" >> $GITHUB_ENV
            echo "PORT=${{ secrets.PROD_PORT }}" >> $GITHUB_ENV
          else
            echo "ENV=staging" >> $GITHUB_ENV
            echo "PORT=${{ secrets.STAGING_PORT }}" >> $GITHUB_ENV
          fi
          IMAGE_NAME=$(echo "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "NUXT_SESSION_PASSWORD=${{ secrets.NUXT_SESSION_PASSWORD }}" >> $GITHUB_ENV
          echo "NUXT_DATABASE_URL=${{ secrets.NUXT_DATABASE_URL }}" >> $GITHUB_ENV

      - name: Build & push Docker image
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.ENV }}
            ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}

      - name: Connect to Tailscale VPN
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        env:
          NUXT_SESSION_PASSWORD: ${{ secrets.NUXT_SESSION_PASSWORD }}
          NUXT_DATABASE_URL: ${{ secrets.NUXT_DATABASE_URL }}
        with:
          host: ${{ secrets[format('{0}_HOST', env.ENV)] }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            mkdir -p /mnt/web_pool/containers/${{ github.event.repository.name }}/${{ env.ENV }}
            cd /mnt/web_pool/containers/${{ github.event.repository.name }}/${{ env.ENV }}
            
            # Always recreate docker-compose.yml
            cat > docker-compose.yml << DOCKER_COMPOSE_EOF
            services:
              app:
                image: ${{ env.IMAGE_NAME }}:${{ env.ENV }}
                container_name: ${{ github.event.repository.name }}-${{ env.ENV }}
                ports:
                  - "${{ env.PORT }}:3000"
                environment:
                  NODE_ENV: production
                  NUXT_SESSION_PASSWORD: ${NUXT_SESSION_PASSWORD}
                  NUXT_DATABASE_URL: ${NUXT_DATABASE_URL}
                volumes:
                  - ./public/uploads:/app/public/uploads
                  - ../uploads-${{ env.ENV }}:/app/public/uploads
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 5s
            DOCKER_COMPOSE_EOF
            
            # Create .env if it doesn't exist
            if [ ! -f .env ]; then
              cat > .env << 'ENV_EOF'
            NODE_ENV=production
            NUXT_SESSION_PASSWORD=${NUXT_SESSION_PASSWORD}
            NUXT_DATABASE_URL=${NUXT_DATABASE_URL}
            ENV_EOF
              echo "⚠️  .env file created - update NUXT_SESSION_PASSWORD and NUXT_DATABASE_URL"
            fi
            
            export NUXT_SESSION_PASSWORD="${{ env.NUXT_SESSION_PASSWORD }}"
            export NUXT_DATABASE_URL="${{ env.NUXT_DATABASE_URL }}"
            
            docker compose pull
            docker compose up -d
